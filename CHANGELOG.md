# История изменений

## Рефакторинг: безопасный запуск, структура, логирование, пересылка админу

Ниже перечислено всё, что было сделано при переходе от одностраничного скрипта к текущей структуре проекта.

---

### 1. Безопасный запуск и переменные окружения

- **Токен бота** больше не хранится в коде. Он читается из переменной окружения `TELEGRAM_BOT_TOKEN`.
- **ID администратора** задаётся в `ADMIN_CHAT_ID` — в этот чат пересылаются заказы.
- Добавлен файл **`.env.example`** — шаблон с переменными. Пользователь копирует его в `.env` и подставляет свои значения.
- В **`config.py`**:
  - загрузка `.env` через `python-dotenv`;
  - проверка наличия `TELEGRAM_BOT_TOKEN` и `ADMIN_CHAT_ID` при старте;
  - при отсутствии переменных — понятное сообщение об ошибке и выход без запуска бота.
- В **`.gitignore`** добавлен `.env`, чтобы секреты не попадали в репозиторий.

---

### 2. Структура проекта (разбиение на модули)

- **`main.py`** — единственная точка входа: загрузка конфига, регистрация всех обработчиков, запуск `bot.infinity_polling()`.
- **`config.py`** — конфигурация из окружения (токен, ADMIN_CHAT_ID, пути к папке данных).
- **`bot.py`** — создание экземпляра `TeleBot` с токеном из `config`.
- **`handlers/`** — пакет с обработчиками:
  - **`handlers/start.py`** — команда `/start`, приветствие и инлайн-кнопки (Каталог, Заказ, Контакты).
  - **`handlers/callbacks.py`** — обработка нажатий этих кнопок (тексты каталога, контактов, подсказка по оформлению заказа).
  - **`handlers/orders.py`** — приём текстовых сообщений как заказов: сохранение, ответ пользователю, пересылка администратору.
- **`handlers/__init__.py`** — функция `register_all(bot)`, которая подключает все хендлеры к боту.
- **`storage/`** — пакет для хранения данных:
  - **`storage/orders.py`** — сохранение заказа в файл и в SQLite.
- **`storage/__init__.py`** — маркер пакета.

Старый одностраничный скрипт **`molotok_bot.py`** оставлен в корне (можно удалить после проверки работы новой версии).

---

### 3. Логирование заказов (файл и БД)

- **Текстовый лог** `data/orders.log`:
  - создаётся папка `data/`, если её нет;
  - каждая строка — один заказ: дата/время, `user_id`, `chat_id`, username, текст заказа (поля через табуляцию, удобно открыть в Excel).
- **SQLite-база** `data/orders.db`:
  - таблица `orders`: `id`, `created_at`, `user_id`, `chat_id`, `username`, `order_text`;
  - создаётся при первом сохранении заказа.
- При каждом новом заказе вызывается **`storage.orders.save_order(...)`** — запись и в файл, и в БД.

---

### 4. Пересылка заказов администратору

- В **`handlers/orders.py`** после сохранения заказа бот отправляет сообщение в чат с **ADMIN_CHAT_ID**.
- В сообщении: текст заказа, `user_id`, username, `chat_id` — чтобы админ мог связаться с клиентом.
- Если отправка админу завершилась с ошибкой, она выводится в консоль; пользователю при этом уже отправлено подтверждение приёма заказа.

---

### 5. Зависимости и документация

- **`requirements.txt`** обновлён: указаны `pyTelegramBotAPI` и `python-dotenv` (в коде используется библиотека `telebot`).
- **`README.md`** — пошаговая инструкция: создание `.env`, установка зависимостей, запуск, структура проекта, описание логирования и пересылки админу.
- **`CHANGELOG.md`** (этот файл) — полное описание внесённых изменений для GitHub и для себя.

---

### Как запускать после изменений

1. Скопировать `.env.example` в `.env` и заполнить `TELEGRAM_BOT_TOKEN` и `ADMIN_CHAT_ID`.
2. Выполнить: `pip install -r requirements.txt`
3. Запуск: `python main.py` из корня проекта.

Остановка: **Ctrl+C**.
